<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body {
    font-size: 0.8rem;
  }
  table,
  th,
  td {
    border: 1px solid #000 !important;
  }
  .bg-merah {
    background-color: #f8d7da !important;
  }
  .bg-biru {
    background-color: #cce5ff !important;
  }
  .bg-cuti {
    background-color: #fff3cd !important;
  }
</style>

<div class="container-fluid p-4">
  <div class="card shadow">
    <div class="card-body">
      <h5 class="text-center fw-bold">
        DATA CUTI PEGAWAI PUSKESMAS TRENGGALEK
      </h5>
      <h6 id="judulBulan" class="text-center"></h6>

      <form method="GET" class="row mb-3">
        <input type="hidden" name="page" value="report" />
        <div class="col-auto">
          <select name="bulan" id="bulanSelect" class="form-select"></select>
        </div>
        <div class="col-auto">
          <select name="tahun" id="tahunSelect" class="form-select"></select>
        </div>
        <div class="col-auto">
          <button class="btn btn-success">Tampilkan</button>
        </div>
        <div class="col-auto">
          <button type="button" class="btn btn-primary" onclick="exportExcel()">
            Export Excel
          </button>
        </div>
      </form>

      <div class="table-responsive">
        <table id="reportTable" class="table table-bordered table-sm">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const url =
    "https://script.google.com/macros/s/AKfycbyPP_a_WHUCLoCQbC119U335ddf7VZG3qxvqx9RoAddxRqXhRpVsj-WZOaP-78jxB4j/exec";

  // ambil bulan & tahun dari URL
  let params = new URLSearchParams(window.location.search);
  let bulan = Number(params.get("bulan")) || new Date().getMonth() + 1;
  let tahun = Number(params.get("tahun")) || new Date().getFullYear();

  // isi dropdown bulan & tahun
  const bulanSelect = document.getElementById("bulanSelect");
  const tahunSelect = document.getElementById("tahunSelect");
  for (let i = 1; i <= 12; i++) {
    bulanSelect.innerHTML += `<option value="${i}" ${
      i === bulan ? "selected" : ""
    }>${new Date(2025, i - 1, 1).toLocaleString("id", {
      month: "long",
    })}</option>`;
  }
  for (let t = tahun - 2; t <= tahun; t++) {
    tahunSelect.innerHTML += `<option value="${t}" ${
      t === tahun ? "selected" : ""
    }>${t}</option>`;
  }

  window.callback = function (list) {
    const jumlahHari = new Date(tahun, bulan, 0).getDate();
    const namaBulan = new Date(tahun, bulan - 1, 1).toLocaleString("id", {
      month: "long",
    });

    let pegawaiMap = {};

    list.forEach((row) => {
      let nip = row["NIP"];
      let nama = row["Nama Pegawai"];
      let jabatan = row["Jabatan"];
      let tglMulai = new Date(row["Tanggal Mulai"]);
      let day = tglMulai.getMonth() + 1 == bulan ? tglMulai.getDate() : null;

      if (!pegawaiMap[nip]) pegawaiMap[nip] = { nama, jabatan, cuti: [] };
      if (day) pegawaiMap[nip].cuti.push(day);
    });

    data = { namaBulan, tahun, jumlahHari, pegawaiMap };
    renderTable();
  };

  function renderTable() {
    document.getElementById(
      "judulBulan"
    ).textContent = `BULAN ${data.namaBulan.toUpperCase()} TAHUN ${data.tahun}`;

    let thead = `<tr class="table-primary text-center">
                 <th rowspan="2">No</th>
                 <th rowspan="2">NAMA PEGAWAI</th>
                 <th rowspan="2">JABATAN</th>
                 <th colspan="${data.jumlahHari}">TANGGAL</th>
               </tr><tr class="table-secondary">`;

    for (let i = 1; i <= data.jumlahHari; i++) {
      thead += `<th>${String(i).padStart(2, "0")}</th>`;
    }
    thead += "</tr>";
    document.getElementById("thead").innerHTML = thead;

    let tbody = "";
    let no = 1;

    Object.values(data.pegawaiMap).forEach((p) => {
      tbody += `<tr>
                <td>${no++}</td>
                <td>${p.nama}</td>
                <td>${p.jabatan}</td>`;
      for (let i = 1; i <= data.jumlahHari; i++) {
        let cls = p.cuti.includes(i) ? "bg-cuti" : "";
        tbody += `<td class="${cls}">${p.cuti.includes(i) ? "1" : ""}</td>`;
      }
      tbody += "</tr>";
    });

    document.getElementById("tbody").innerHTML = tbody;
  }

  // fetch GAS
  fetch(url)
    .then((r) => r.text())
    .then((txt) => eval(txt));

  function exportExcel() {
    const table = document.getElementById("reportTable");
    const workbook = XLSX.utils.table_to_book(table, { sheet: "Data Cuti" });
    XLSX.writeFile(workbook, `Data_Cuti_${data.namaBulan}_${data.tahun}.xlsx`);
  }
</script>
