<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Input Data Cuti - Aplikasi Cuti Puskesmas</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Flatpickr -->
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #dbeafe 0%, #f0fdfa 100%);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: linear-gradient(135deg, #4ade80, #22d3ee);
        color: #fff;
        padding: 2rem;
      }
      .form-label {
        font-weight: 600;
        color: #374151;
      }
      input.form-control,
      select.form-select,
      textarea.form-control {
        border-radius: 12px;
        transition: all 0.2s;
      }
      input.form-control:focus,
      select.form-select:focus,
      textarea.form-control:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
      }
      .btn-primary {
        border-radius: 12px;
        padding: 0.55rem 1.5rem;
        font-weight: 600;
      }
      footer {
        margin-top: auto;
        text-align: center;
        padding: 1rem;
        color: #111827;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>
          <i class="fa-solid fa-pen-to-square text-primary me-2"></i>Form Input
          Cuti
        </h3>
        <a href="index.html" class="btn btn-outline-secondary btn-sm shadow-sm">
          <i class="fa-solid fa-arrow-left me-1"></i>Kembali
        </a>
      </div>

      <div class="card">
        <h5 class="mb-3 fw-semibold text-white">
          <i class="fa-solid fa-circle-info me-2"></i>Informasi Pegawai
        </h5>

        <form id="formCuti">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nama Pegawai</label>
              <input
                type="text"
                class="form-control"
                id="namaPegawai"
                readonly
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">NIP</label>
              <input type="text" class="form-control" id="nip" readonly />
            </div>
            <div class="col-md-4">
              <label class="form-label">Jabatan</label>
              <input type="text" class="form-control" id="jabatan" readonly />
            </div>
            <div class="col-md-4">
              <label class="form-label">Jenis Cuti</label>
              <select class="form-select" id="jenisCuti" required>
                <option value="">-- Pilih Jenis Cuti --</option>
                <option>Cuti Tahunan</option>
                <option>Cuti Sakit</option>
                <option>Cuti Melahirkan</option>
                <option>Cuti Besar</option>
                <option>Cuti Alasan Penting</option>
              </select>
            </div>
          </div>

          <div class="row mt-2">
            <div class="col-md-4">
              <label class="form-label">Tanggal Mulai</label>
              <input type="text" class="form-control" id="tglMulai" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Tanggal Selesai</label>
              <input
                type="text"
                class="form-control"
                id="tglSelesai"
                required
              />
            </div>
            <div class="col-md-2">
              <label class="form-label">Lama Cuti (hari)</label>
              <input
                type="text"
                class="form-control text-center"
                id="lamaCuti"
                readonly
              />
            </div>

            <div class="col-6 mt-2">
              <label class="form-label">Keterangan</label>
              <textarea
                class="form-control"
                id="keterangan"
                rows="3"
                required
              ></textarea>
            </div>

            <div class="col-6 mt-2">
              <label class="form-label">Alamat Selama Cuti</label>
              <textarea
                class="form-control"
                id="alamat"
                rows="3"
                required
              ></textarea>
            </div>

            <div class="col-4 mt-2" id="filePendukungWrapper">
              <label class="form-label">Upload File Pendukung (opsional)</label>
              <input
                type="file"
                class="form-control"
                id="filePendukung"
                accept=".pdf,.jpg,.jpeg,.png"
              />
            </div>

            <div class="col-4 mt-2">
              <label class="form-label">Nomor Telepon Selama Cuti</label>
              <input
                type="text"
                class="form-control"
                id="noTelp"
                maxlength="12"
                inputmode="numeric"
                pattern="[0-9]*"
                oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,12)"
                placeholder="Masukkan nomor telepon (max 12 digit)"
              />
            </div>
          </div>

          <div class="mt-4 text-end">
            <button
              type="submit"
              class="btn btn-light fw-bold text-success shadow-sm"
            >
              <i class="fa-solid fa-paper-plane me-1"></i>Ajukan Cuti
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer>System Cuti Pegawai Puskesmas Trenggalek | @yoga</footer>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Bootstrap & Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const userData = localStorage.getItem("userData");
        if (!userData) {
          window.location.href = "index.html";
          return;
        }
        const user = JSON.parse(userData);
        document.getElementById("namaPegawai").value = user.nama || "";
        document.getElementById("nip").value = user.nip || "";
        document.getElementById("jabatan").value = user.jabatan || "";

        const holidays = [
          "2025-01-01",
          "2025-01-27",
          "2025-01-28",
          "2025-01-29",
          "2025-03-28",
          "2025-03-29",
          "2025-03-31",
          "2025-04-01",
          "2025-04-02",
          "2025-04-03",
          "2025-04-04",
          "2025-04-07",
          "2025-04-18",
          "2025-04-20",
          "2025-05-01",
          "2025-05-12",
          "2025-05-13",
          "2025-05-29",
          "2025-05-30",
          "2025-06-01",
          "2025-06-06",
          "2025-06-09",
          "2025-06-27",
          "2025-08-17",
          "2025-08-18",
          "2025-09-05",
          "2025-12-25",
          "2025-12-26",
        ];

        flatpickr("#tglMulai", { dateFormat: "Y-m-d" });
        flatpickr("#tglSelesai", { dateFormat: "Y-m-d" });
        // === Sembunyikan/lihat input file tergantung jenis cuti ===
        const jenisCutiSelect = document.getElementById("jenisCuti");
        const filePendukungWrapper = document.getElementById(
          "filePendukungWrapper"
        );

        // Sembunyikan dulu di awal
        filePendukungWrapper.style.display = "none";

        // Saat pilihan berubah
        jenisCutiSelect.addEventListener("change", () => {
          const selected = jenisCutiSelect.value.trim().toLowerCase();
          if (selected === "cuti tahunan" || selected === "") {
            filePendukungWrapper.style.display = "none";
            document.getElementById("filePendukung").value = ""; // reset file
          } else {
            filePendukungWrapper.style.display = "block";
          }
        });

        function hitungLama() {
          const start = document.getElementById("tglMulai").value;
          const end = document.getElementById("tglSelesai").value;
          if (start && end) {
            const s = new Date(start);
            const e = new Date(end);
            let count = 0;
            for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
              const day = d.getDay();
              const tgl = d.toISOString().split("T")[0];
              if (day !== 0 && day !== 6 && !holidays.includes(tgl)) count++;
            }
            document.getElementById("lamaCuti").value = count;
          }
        }

        document
          .getElementById("tglMulai")
          .addEventListener("change", hitungLama);
        document
          .getElementById("tglSelesai")
          .addEventListener("change", hitungLama);

        function fileToBase64(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        document
          .getElementById("formCuti")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            // Ambil semua nilai input
            const jenisCuti = document.getElementById("jenisCuti").value.trim();
            const tglMulai = document.getElementById("tglMulai").value.trim();
            const tglSelesai = document
              .getElementById("tglSelesai")
              .value.trim();
            const lamaCuti = document.getElementById("lamaCuti").value.trim();
            const keterangan = document
              .getElementById("keterangan")
              .value.trim();
            const alamat = document.getElementById("alamat").value.trim();
            const noTelp = document.getElementById("noTelp").value.trim();
            const fileInput = document.getElementById("filePendukung");

            // 🔍 Validasi manual
            if (
              !jenisCuti ||
              !tglMulai ||
              !tglSelesai ||
              !lamaCuti ||
              !keterangan ||
              !alamat ||
              !noTelp
            ) {
              Swal.fire({
                icon: "warning",
                title: "Lengkapi Data!",
                text: "Semua kolom wajib diisi sebelum mengajukan cuti.",
              });
              return;
            }

            // 🔍 Validasi nomor telepon (harus angka & minimal 8 digit)
            if (!/^[0-9]{8,12}$/.test(noTelp)) {
              Swal.fire({
                icon: "warning",
                title: "Nomor Telepon Tidak Valid!",
                text: "Masukkan nomor telepon 8–12 digit angka tanpa spasi atau simbol.",
              });
              return;
            }

            // 🔍 Validasi file pendukung
            if (jenisCuti.toLowerCase() !== "cuti tahunan") {
              if (fileInput.files.length === 0) {
                Swal.fire({
                  icon: "warning",
                  title: "File Pendukung Wajib!",
                  text: "Jenis cuti ini memerlukan file pendukung (PDF/JPG/PNG).",
                });
                return;
              }
            }

            // Jika semua validasi lolos, tampilkan loading
            Swal.fire({
              title: "Mengirim Data...",
              text: "Mohon tunggu sebentar",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
            });

            // Konversi file ke base64
            let fileBase64 = "",
              fileName = "";
            if (fileInput.files.length > 0) {
              fileName = fileInput.files[0].name;
              fileBase64 = await fileToBase64(fileInput.files[0]);
            }

            // Buat payload
            const payload = {
              nip: user.nip || "",
              namaPegawai: user.nama || "",
              jabatan: user.jabatan || "",
              tglMulai,
              tglSelesai,
              lamaCuti,
              jenisCuti,
              keterangan,
              alamat,
              noTelp,
              fileBase64,
              fileName,
            };

            try {
              const res = await fetch(
                "https://script.google.com/macros/s/AKfycbzt6xv3yHqeRiTrNcmghTwAq5cgpJ873CF3S4t4XC5qQTa60fcUFILFIdOk9KFaO0o2/exec",
                {
                  method: "POST",
                  body: JSON.stringify(payload),
                }
              );

              const data = await res.json();
              if (data.status === "success") {
                Swal.fire({
                  icon: "success",
                  title: "Berhasil!",
                  text: "Pengajuan cuti berhasil dikirim.",
                  showConfirmButton: false,
                  timer: 2000,
                });

                setTimeout(() => {
                  window.location.href = "dashboard.html";
                }, 2000);
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Gagal!",
                  text: data.message || "Terjadi kesalahan saat mengirim data.",
                });
              }
            } catch (err) {
              Swal.fire({
                icon: "error",
                title: "Error!",
                text: err.message,
              });
            }
          });
      });
    </script>
  </body>
</html>
