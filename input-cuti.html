<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Input Data Cuti - Aplikasi Cuti Puskesmas</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Flatpickr -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    body { 
      background: linear-gradient(135deg, #f5f7fa 0%, #e0e7ff 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card{
      border:none; 
      border-radius:20px;
      box-shadow:0 4px 20px rgba(0,0,0,.1);
      transition: transform 0.2s, box-shadow 0.3s;
      background:#fff;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow:0 8px 25px rgba(0,0,0,.15);
    }
    .form-label { font-weight:600; color:#374151; }
    input.form-control, select.form-select, textarea.form-control{
      border-radius:12px;
      transition: all 0.2s;
    }
    input.form-control:focus, select.form-select:focus, textarea.form-control:focus{
      border-color:#4f46e5;
      box-shadow:0 0 0 0.2rem rgba(79,70,229,.25);
    }
    .btn-primary{
      border-radius:12px;
      padding:0.55rem 1.5rem;
      font-weight:600;
    }
    .header-section{
      margin-bottom:1.5rem;
    }
    .header-section h3{
      font-weight:700;
      color:#1f2937;
    }
    .header-section a.btn{
      font-weight:500;
    }
    .badge-info{
      background:#eef2ff; color:#4f46e5; font-weight:500;
    }
  </style>
</head>
<body>
  <div class="container py-5">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center header-section">
    <h3>
      <i class="fa-solid fa-pen-to-square text-primary me-2"></i>Form Input Cuti
    </h3>
    <a href="index.html" class="btn btn-outline-secondary btn-sm">
      <i class="fa-solid fa-arrow-left me-1"></i>Kembali
    </a>
  </div>

  <!-- Card Form -->
  <div class="card position-relative overflow-hidden" style="background: linear-gradient(135deg, #4ade80, #22d3ee); color:#fff; padding:2rem;">
    <!-- Header Form -->
    <h5 class="mb-3 fw-semibold">
      <i class="fa-solid fa-circle-info me-2"></i>Informasi Pegawai
    </h5>

    <form id="formCuti">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Nama Pegawai</label>
          <input type="text" class="form-control" id="namaPegawai" readonly style="border-radius:12px;">
        </div>
        <div class="col-md-6">
          <label class="form-label">Jabatan</label>
          <input type="text" class="form-control" id="jabatan" readonly style="border-radius:12px;">
        </div>
        <div class="col-md-6">
          <label class="form-label">Tanggal Mulai</label>
          <input type="text" class="form-control" id="tglMulai" placeholder="Pilih tanggal mulai" required style="border-radius:12px;">
        </div>
        <div class="col-md-6">
          <label class="form-label">Tanggal Selesai</label>
          <input type="text" class="form-control" id="tglSelesai" placeholder="Pilih tanggal selesai" required style="border-radius:12px;">
        </div>
        <div class="col-md-4">
          <label class="form-label">Lama Cuti (hari)</label>
          <input type="text" class="form-control fw-bold text-center" id="lamaCuti" readonly style="border-radius:12px;">
        </div>
        <div class="col-md-8">
          <label class="form-label">Jenis Cuti</label>
          <select class="form-select" id="jenisCuti" required style="border-radius:12px;">
            <option value="">-- Pilih Jenis Cuti --</option>
            <option>Cuti Tahunan</option>
            <option>Cuti Sakit</option>
            <option>Cuti Melahirkan</option>
            <option>Cuti Besar</option>
            <option>Cuti Alasan Penting</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Keterangan</label>
          <textarea class="form-control" id="keterangan" rows="3" placeholder="Tuliskan keterangan cuti..." required style="border-radius:12px;"></textarea>
        </div>
        <div class="col-12" id="filePendukungWrapper">
          <label class="form-label">Upload File Pendukung (opsional)</label>
          <input type="file" class="form-control" id="filePendukung" accept=".pdf,.jpg,.jpeg,.png" style="border-radius:12px;">
        </div>
      </div>

      <div class="mt-4 text-end">
        <button type="submit" class="btn btn-primary text-white fw-bold" style="border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.15);">
          <i class="fa-solid fa-paper-plane me-1"></i>Ajukan Cuti
        </button>
      </div>
    </form>

    <!-- Efek dekoratif ikon besar di kanan atas -->
    <div style="position:absolute; top:-20px; right:-20px; font-size:5rem; opacity:0.15;">
      <i class="fa-solid fa-pen-to-square"></i>
    </div>
  </div>
</div>



  <!-- Toast dan Spinner -->
<div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 1080; min-width: 300px;">
  <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body d-flex align-items-center">
        <div id="toastSpinner" class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span id="toastBody">Memproses pengajuan cuti...</span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
 <script>
document.addEventListener("DOMContentLoaded", () => {
  // load user info
  const userData = localStorage.getItem("userData");
  if (!userData) {
    window.location.href = "index.html";
    return;
  }
  const user = JSON.parse(userData);
  document.getElementById("namaPegawai").value = user.nama || "";
  document.getElementById("jabatan").value = user.jabatan || "";

  // daftar tanggal merah (format: YYYY-MM-DD)
  const holidays = [
    "2025-01-01","2025-01-27","2025-01-28","2025-01-29","2025-03-28","2025-03-29","2025-03-31",
    "2025-04-01","2025-04-02","2025-04-03","2025-04-04","2025-04-07","2025-04-18","2025-04-20",
    "2025-05-01","2025-05-12","2025-05-13","2025-05-29","2025-05-30","2025-06-01","2025-06-06",
    "2025-06-09","2025-06-27","2025-08-17","2025-08-18","2025-09-05","2025-12-25","2025-12-26"
  ];

  // init flatpickr
  flatpickr("#tglMulai", { dateFormat: "Y-m-d" });
  flatpickr("#tglSelesai", { dateFormat: "Y-m-d" });

  // fungsi hitung lama cuti (abaikan sabtu, minggu, tanggal merah)
function hitungLama() {
  const start = document.getElementById("tglMulai").value;
  const end = document.getElementById("tglSelesai").value;
  if (start && end) {
    let s = new Date(start);
    let e = new Date(end);

    // Set jam ke 00:00 agar aman
    s.setHours(0,0,0,0);
    e.setHours(0,0,0,0);

    if (e >= s) {
      let count = 0;
      let d = new Date(s);
      while (d <= e) {
        const day = d.getDay(); // 0 = Minggu, 6 = Sabtu
        const tgl = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if (day !== 0 && day !== 6 && !holidays.includes(tgl)) {
          count++;
        }
        d.setDate(d.getDate() + 1);
      }
      document.getElementById("lamaCuti").value = count;
    } else {
      document.getElementById("lamaCuti").value = "";
    }
  }
}
// ===== Mulai logika sembunyikan file pendukung =====
const jenisCutiEl = document.getElementById("jenisCuti");
const filePendukungWrapper = document.getElementById("filePendukung").closest(".col-12");

// fungsi tampil/hidden file pendukung
function toggleFilePendukung() {
  if (jenisCutiEl.value === "Cuti Tahunan") {
    filePendukungWrapper.style.display = "none";
    filePendukung.value = ""; // reset file jika ada
  } else {
    filePendukungWrapper.style.display = "block";
  }
}

// inisialisasi saat load
toggleFilePendukung();

// listen perubahan jenis cuti
jenisCutiEl.addEventListener("change", toggleFilePendukung);
// ===== Selesai logika sembunyikan file pendukung =====

document.getElementById("tglMulai").addEventListener("change", hitungLama);
document.getElementById("tglSelesai").addEventListener("change", hitungLama);


  // helper convert file ke base64
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = ()=>resolve(reader.result.split(",")[1]);
      reader.onerror = err=>reject(err);
    });
  }

  // submit form
document.getElementById("formCuti").addEventListener("submit", async e => {
  e.preventDefault();

  const fileInput = document.getElementById("filePendukung");
  let fileBase64 = "";
  let fileName = "";

  if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    fileName = file.name;
    fileBase64 = await fileToBase64(file);
  }

  const payload = {
    nip: user.nip || "",
    namaPegawai: user.nama || "",
    jabatan: user.jabatan || "",
    tglMulai: document.getElementById("tglMulai").value,
    tglSelesai: document.getElementById("tglSelesai").value,
    lamaCuti: document.getElementById("lamaCuti").value,
    jenisCuti: document.getElementById("jenisCuti").value,
    keterangan: document.getElementById("keterangan").value,
    fileBase64,
    fileName,
    status: "Menunggu Persetujuan"
  };

  const toastEl = document.getElementById("liveToast");
const toastBody = document.getElementById("toastBody");
const toastSpinner = document.getElementById("toastSpinner");

// buat instance toast, matikan autohide agar tetap terlihat
const toast = new bootstrap.Toast(toastEl, { autohide: false });

// tampilkan toast saat mulai submit
toastBody.textContent = "Mengirim data ke spreadsheet...";
toastSpinner.style.display = "inline-block";
toast.show();

try {
  const res = await fetch("https://script.google.com/macros/s/AKfycbzt6xv3yHqeRiTrNcmghTwAq5cgpJ873CF3S4t4XC5qQTa60fcUFILFIdOk9KFaO0o2/exec", {
    method: "POST",
    body: JSON.stringify(payload)
  });
  const data = await res.json();

  // sembunyikan spinner saat selesai
  toastSpinner.style.display = "none";

  if (data.status === "success") {
    toastBody.textContent = "✅ Pengajuan cuti berhasil disimpan!";
    // bisa otomatis hide setelah 3 detik
    setTimeout(() => toast.hide(), 3000);
    document.getElementById("formCuti").reset();
    document.getElementById("lamaCuti").value = "";
  } else {
    toastBody.textContent = "❌ Gagal: " + data.message;
    toast.show(); // pastikan toast terlihat
  }

} catch(err){
  toastSpinner.style.display = "none";
  toastBody.textContent = "❌ Error: " + err.message;
  toast.show();
}

});

});

</script>

</body>
</html>
